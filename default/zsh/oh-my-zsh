# Omarchy - oh-my-zsh integration helper
#
# This file centralizes the bits of configuration that come from your
# ~/.zshconf (the user's oh-my-zsh style config) and ensures the pieces
# are loaded in a well-structured, safe order:
#
# 1. Load user-provided ~/.zshconf (if present) so their overrides apply.
# 2. Ensure essential variables (like $ZSH) are set.
# 3. Load oh-my-zsh core if available.
# 4. Load common third-party completion/syntax plugins when present.
# 5. Provide conservative defaults and non-destructive aliases/fallbacks.
#
# This file is intended to be sourced from the main zsh `rc` file:
#   source ~/.local/share/omarchy/default/zsh/oh-my-zsh
#
# It will not clobber existing settings (it prefers existing environment
# values and user config in ~/.zshconf).

# ---- 1) Load user oh-my-zsh style config (~/.zshconf) if it exists ----
if [[ -f "${HOME}/.zshconf" ]]; then
  # Source the user's oh-my-zsh config so their chosen variables/plugins
  # are available to the rest of this file.
  #
  # We source instead of attempting to "read and parse" because the file
  # may contain arbitrary zsh code (exports, conditionals, etc).
  source "${HOME}/.zshconf"
fi

# ---- 2) Ensure essential variables / sane defaults ----
# Default location for oh-my-zsh installation
: ${ZSH:="${HOME}/.oh-my-zsh"}
export ZSH

# zoxide command override - allow user config to override this if present
: ${ZOXIDE_CMD_OVERRIDE:="cd"}
export ZOXIDE_CMD_OVERRIDE

# Allow `autocd` to work if not already set and not explicitly disabled
if ! setopt | grep -q '^NO_'; then
  # If user didn't already enable autocd explicitly, enable it as a convenience.
  # If they set it in ~/.zshconf it will already have taken effect.
  setopt autocd 2>/dev/null || true
fi

# ---- 3) Load oh-my-zsh core (if installed) ----
if [[ -n "$ZSH" && -f "${ZSH}/oh-my-zsh.sh" ]]; then
  # Many themes and plugins expect `plugins=(...)` to be defined before
  # sourcing the core. The user's ~/.zshconf may have already set it.
  #
  # If it's undefined, set a conservative default list.
  if [[ -z "${plugins+x}" ]]; then
    plugins=(git fzf)
  fi

  # Source OMZ core
  source "${ZSH}/oh-my-zsh.sh"
fi

# ---- 4) Load commonly packaged plugin scripts (if installed system-wide) ----
# Load zsh-autosuggestions and zsh-syntax-highlighting if present and not
# already loaded by the user's config.
if [[ -z "${ZSH_AUTOSUGGESTIONS_LOADED:-}" ]]; then
  if [[ -f /usr/share/zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh ]]; then
    source /usr/share/zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh
    typeset -g ZSH_AUTOSUGGESTIONS_LOADED=1
  elif [[ -f "${HOME}/.oh-my-zsh/custom/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh" ]]; then
    source "${HOME}/.oh-my-zsh/custom/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh"
    typeset -g ZSH_AUTOSUGGESTIONS_LOADED=1
  fi
fi

if [[ -z "${ZSH_SYNTAX_HIGHLIGHTING_LOADED:-}" ]]; then
  if [[ -f /usr/share/zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh ]]; then
    source /usr/share/zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
    typeset -g ZSH_SYNTAX_HIGHLIGHTING_LOADED=1
  elif [[ -f "${HOME}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" ]]; then
    source "${HOME}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
    typeset -g ZSH_SYNTAX_HIGHLIGHTING_LOADED=1
  fi
fi

# If zoxide is installed and the user didn't already initialize it, attempt init.
if command -v zoxide >/dev/null 2>&1; then
  # Prefer user-defined init invocation (e.g. eval "$(zoxide init zsh)") if present.
  # Otherwise, perform a safe init here.
  if ! typeset -f __zoxide_init >/dev/null 2>&1; then
    if [[ -z "${ZOXIDE_INIT_DONE:-}" ]]; then
      eval "$(zoxide init zsh 2>/dev/null)" || true
      typeset -g ZOXIDE_INIT_DONE=1
    fi
  fi
fi

# Starship prompt initialization if available and not already done
if command -v starship >/dev/null 2>&1 && [[ -z "${STARSHIP_INIT_DONE:-}" ]]; then
  eval "$(starship init zsh)" 2>/dev/null || true
  typeset -g STARSHIP_INIT_DONE=1
fi

# mise environment activation if installed
if command -v mise >/dev/null 2>&1 && [[ -z "${MISE_INIT_DONE:-}" ]]; then
  eval "$(mise activate zsh)" 2>/dev/null || true
  typeset -g MISE_INIT_DONE=1
fi

# ---- 5) Apply zstyle settings and other small niceties ----
# If the user set zstyle lines in ~/.zshconf we keep them. Otherwise,
# provide conservative zstyle defaults for `eza` if the plugin is in use.
if (( ${+plugins[(r)eza]} )); then
  # Only set zstyles if they aren't already defined by the user's config.
  # zstyle does not provide an easy "is set" query, so we test one known key.
  if ! zstyle -t ':omz:plugins:eza' 'dirs-first' >/dev/null 2>&1; then
    zstyle ':omz:plugins:eza' 'dirs-first' yes 2>/dev/null || true
  fi
  if ! zstyle -t ':omz:plugins:eza' 'icons' >/dev/null 2>&1; then
    zstyle ':omz:plugins:eza' 'icons' yes 2>/dev/null || true
  fi
  # header is okay to set as well if not present
  zstyle ':omz:plugins:eza' 'header' yes 2>/dev/null || true
fi

# ---- 6) Preferred editor, architecture flags, and conservative aliases ----
# Allow ~/.zshconf to set EDITOR; if not present, set it based on SSH.
if [[ -z "${EDITOR:-}" ]]; then
  if [[ -n "${SSH_CONNECTION:-}" ]]; then
    export EDITOR='vim'
  else
    export EDITOR='nvim'
  fi
fi

# ARCHFLAGS fallback (user may have set it in ~/.zshconf)
if [[ -z "${ARCHFLAGS:-}" ]]; then
  export ARCHFLAGS="-arch $(uname -m)"
fi

# Define a few useful aliases only if they are not already defined by the user.
# This avoids clobbering custom choices in ~/.zshconf.
if ! alias ls >/dev/null 2>&1; then
  if command -v eza >/dev/null 2>&1; then
    alias ls='eza -la --icons=auto'
  else
    alias ls='ls -la'
  fi
fi

if ! alias n >/dev/null 2>&1; then
  if command -v nvim >/dev/null 2>&1; then
    alias n='nvim'
  elif command -v vim >/dev/null 2>&1; then
    alias n='vim'
  fi
fi

if ! alias lg >/dev/null 2>&1 && command -v lazygit >/dev/null 2>&1; then
  alias lg='lazygit'
fi

if ! alias lzd >/dev/null 2>&1 && command -v lazydocker >/dev/null 2>&1; then
  alias lzd='lazydocker'
fi

# ---- 7) Non-invasive logging for diagnostics (kept minimal) ----
# Do not print in non-interactive shells.
if [[ $- == *i* ]]; then
  # Indicate we loaded the oh-my-zsh helper from Omarchy (quiet by default)
  # Uncomment the line below if you want a short message each interactive session:
  # printf '%s\n' "Loaded Omarchy oh-my-zsh helper"
  :
fi

# End of omarchy/default/zsh/oh-my-zsh
